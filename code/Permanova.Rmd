---
title: "PERMANOVA test"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(phyloseq)
library(vegan)
library(phangorn)
library(DECIPHER)
library(here)
library(reshape2)
theme_set(theme_minimal())
```

```{r}
# OTU table is in proportion in this situation
ps <- readRDS(here('Rdata','following_study','ps.rds')) %>%
    transform_sample_counts(function(x) x / sum(x) )
fitGTR <- readRDS(here('Rdata','following_study','fitGTR.rds'))
psord <- merge_phyloseq(ps, phy_tree(fitGTR$tree))

```


```{r}
ord.bray.mds <- ordinate(psord, method="MDS", distance="bray")
ord.bray.nmds <- ordinate(psord, method="NMDS", distance="bray")
ord.wuf.mds <- ordinate(psord, method="MDS", distance="wunifrac")
ord.wuf.nmds <- ordinate(psord, method="NMDS", distance="wunifrac")
```

```{r}
plot.ord <- function(psi, ordi, color="Group", label="Household", size=3, axes=c(1,2)) {
  p <- plot_ordination(psi, ordi, axes=axes)
  ggplot(data=p$data, aes_string(x=quo_name(p$mapping$x), y=quo_name(p$mapping$y), 
                                 color=color, label=label)) + geom_text(size=size, check_overlap = T)
}

p.bray <- plot.ord(psord, ord.bray.mds)
p.bray + ggtitle("Bray - MDS")
plot.ord(psord, ord.bray.nmds) + ggtitle("Bray - NMDS")

p.wuf <- plot.ord(psord, ord.wuf.mds)
p.wuf + ggtitle("WUF - MDS")
plot.ord(psord, ord.wuf.nmds) + ggtitle("WUF - NMDS")
```

```{r}
ds <- phyloseq::distance(psord, 'unifrac') 
sam <- sample_data(psord)
sam.dic <- hash::hash(rownames(sam), sam$Household)
ds.m = as.matrix(ds) %>% 
    melt() %>% as.data.frame() 
# sam.dic[ds.m$Var1]
```


permanova test for household

```{r}
bc <- phyloseq::distance(psord, method="bray")
samdf.ord <- data.frame(sample_data(psord))
vegan::adonis2(bc ~ Household, data = samdf.ord, permutations=1e4)
```

```{r}
vegan::adonis2(bc ~ Pheno.or.drug.naive, data = samdf.ord, permutations=1e4)
```


```{r}
vegan::adonis2(bc ~ Pheno.or.drug.naive + Group, data = samdf.ord, permutations=1e4)
```

# PCoA

```{r}
ps.uf <- UniFrac(psord)
pcoa <- ordinate(psord, method="PCoA", distance=ps.uf)
plot_scree(pcoa)
plot.ord(psord, pcoa)
```


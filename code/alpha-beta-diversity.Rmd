---
title: "alpha-beta-diversity"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set Up

```{r message=FALSE}
library(tidyverse)
library(here)
library(phyloseq)
library(vegan)
theme_set(theme_bw())
filt_fun <- function (x, min_reads = 100, min_samples = 5) {
    (sum(x) > min_reads) & (sum(x > 0) > min_samples)
}
ps <- readRDS(here('data','following_study','ps_rarefied.rds')) %>% 
    filter_taxa(filt_fun, prune = TRUE) 
sample_data(ps)[is.na(sample_data(ps))] <- 'NA'
sam <- data.frame(sample_data(ps))
max.core <- parallel::detectCores()
```

# Alpha Diversity

```{r}
alpha.diversity <- data.frame(sample_data(ps),estimate_richness(ps),read_depth = rowSums(otu_table(ps)))
```

## Household Effect

```{r}
ggplot(alpha.diversity,aes(x = as.numeric(Household), y = Shannon, group = Household)) +
    geom_point() + geom_line() + xlab('Household')
```

```{r}
anova(lm(Shannon~Household, data = alpha.diversity))
```

## Epileptic Effect

```{r}
ggplot(alpha.diversity,aes(x = Epileptic.or.Control, y = Shannon)) +
    geom_boxplot() + geom_jitter(height = 0, width = 0.25)
```

Paired t test

```{r}
epileptic <- alpha.diversity %>% filter(Epileptic.or.Control == 'Epileptic')
control <- alpha.diversity %>% filter(Epileptic.or.Control == 'Control')
t.test(epileptic$Shannon, control$Shannon, paired = TRUE)
```

ANOVA with `Household` effect added

```{r}
anova(lm(Shannon~Household + Epileptic.or.Control, data = alpha.diversity))
```

## Breed Effect

```{r}
ggplot(alpha.diversity) +
    geom_point(aes(x = Breed.Group..1., y = Shannon, colour = Breed.Group..1.)) +
    facet_wrap(~Epileptic.or.Control) + 
    theme(axis.text.x = element_blank(), axis.ticks.x.bottom = element_blank())
```

```{r}
# here breed group with na is removed 
anova(lm(Shannon~Household + Breed.Group..1., data = alpha.diversity %>% filter(Breed.Group..1. != 'NA')))
```

## Drug Effect

```{r}
alpha.diversity.epi <- alpha.diversity %>% filter(Epileptic.or.Control == 'Epileptic')
ggplot(alpha.diversity.epi, aes(x = Pheno.Y.N, y = Shannon)) +
    geom_boxplot() + geom_jitter(height = 0, width = 0.25)
```

```{r}
t.test(Shannon~Pheno.Y.N, data = alpha.diversity.epi)
```

## Sex Effect

```{r}
ggplot(alpha.diversity, aes(x = Sex, y = Shannon)) +
    geom_boxplot() + geom_jitter(height = 0, width = 0.25)
```

```{r}
anova(lm(Shannon~Household + Sex, data = alpha.diversity))
t.test(Shannon~Sex, data = alpha.diversity)
```

## Age Effect

```{r}
ggplot(alpha.diversity, aes(x = as.numeric(Age..months.), y = Shannon)) +
    geom_point()
```

```{r}
lm(Shannon~as.numeric(Age..months.), data = alpha.diversity) %>% summary()
```


# Beta Diversity

```{r}
ord <- ps %>% ordinate(method = "MDS", distance = 'unifrac')
plot_ordination(ps, ord)
```

The PCoA plot shows a very separate pattern of four clusters. Let's take a look at the phlogenetic tree of our data.

```{r}
plot_tree(ps, "treeonly")
```

Some of the taxa have extremely long branch. Are they influential?

```{r warning=FALSE}
# Warning: Not all nodes are descendants in this tree
if (require(adephylo)) {dist.root <- adephylo::distRoot(phy_tree(ps))}
hist(dist.root); dist.root %>% sort(decreasing = TRUE) %>% head(20)
detach('package:adephylo', character.only = TRUE, unload = TRUE, force = TRUE)
```

Let's see which ASV has distance from root longer than 10.

```{r}
long.branch <- dist.root[dist.root > 5]
long.branch
```

Are these ASVs special?

```{r}
dada2:::pfasta(refseq(ps)[names(long.branch)], ids = names(long.branch))
```

Result returned from BLAST (web interface):

|  ASV   |        Taxonomy        | \% identity |
|:------:|:----------------------:|:-----------:|
| ASV601 | Anaerobutyricum hallii |    95.1     |
| ASV438 | uncultured Blautia sp. |    97.3     |

Now we remove this outlier ASVs

```{r, message=FALSE}
all.taxa <- taxa_names(ps)
keep.taxa <- all.taxa[!(all.taxa %in% names(long.branch))]
ps.sub <- ps %>% prune_taxa(keep.taxa, .)
```

Convert ps.sub to proportion

```{r, message=FALSE}
ps.sub <- ps.sub %>% transform_sample_counts(function(x) x / sum(x))
sample_sums(ps.sub) %>% summary()
```

# Test for Effect

```{r}
plot_ord <- function(data, factor, method, distance){
    data.ord <- ordinate(data, method = method, distance = distance)
    p <- plot_ordination(data, data.ord, color = factor)
    p <- p + stat_ellipse(type = "t",geom = "polygon",alpha = 0)
    p <- p + ggtitle(str_c(factor,method,distance, sep = ' - '))
    print(p)
}
permanova <- function(data, formula, method, permutations=1e4, strata = NULL, core = max.core){
    dist.matrix <- phyloseq::distance(data, method=method)
    df <- data.frame(sample_data(data))
    model <- as.formula(paste0('dist.matrix~', formula))
    if (!is_null(strata)) {strata <- df[,strata]}
    result <- adonis2(model,
                      data = df,
                      permutations=permutations,
                      strata = strata,
                      parallel = core)
    return(result)
}
permdisp <- function(data, group, method, permutations=1e4, pairwise = FALSE, core = max.core){
    dist.matrix <- phyloseq::distance(data, method=method)
    df <- data.frame(sample_data(data))
    beta.disp <- betadisper(dist.matrix, group = df[,group])
    result <- permutest(beta.disp, permutations = permutations, pairwise = pairwise, type = 'centroid')
    return(result)
}
```

## Household Effect

```{r}
permanova(ps.sub, 'Household', 'bray')
```

## Epileptic Effect

### Ordination

```{r}
plot_ord(ps.sub, 'Epileptic.or.Control','MDS','bray')
plot_ord(ps.sub, 'Epileptic.or.Control','MDS','wunifrac')
plot_ord(ps.sub, 'Epileptic.or.Control','NMDS','bray')
plot_ord(ps.sub, 'Epileptic.or.Control','NMDS','wunifrac')
```

### PERMANOVA Test

```{r}
permanova(ps.sub, 'Epileptic.or.Control', 'bray', strata = 'Household')
permanova(ps.sub, 'Epileptic.or.Control', 'wunifrac', strata = 'Household')
```

### PERMDISP

```{r}
permdisp(ps.sub, 'Epileptic.or.Control', 'bray')
permdisp(ps.sub, 'Epileptic.or.Control', 'wunifrac')
```

## Breed Effect

a table of \# of breed. frequency table

```{r}
(data.frame(sample_data(ps.sub))$Breed.Group..1.) %>% table()
```

```{r}
plot_ord(ps.sub, 'Breed.Group..1.','MDS','bray')
plot_ord(ps.sub, 'Breed.Group..1.','MDS','wunifrac')
plot_ord(ps.sub, 'Breed.Group..1.','NMDS','bray')
plot_ord(ps.sub, 'Breed.Group..1.','NMDS','wunifrac')
```

### PERMANOVA

```{r}
# same breed group v.s. diff breed group in household
# check if data are paired within household
if (!identical(sample_data(ps)$Household[seq(1,98,2)],
               sample_data(ps)$Household[seq(1,98,2)+1])) stop('data is not paired')

same.breed.group <- table(sample_data(ps)$Household, sample_data(ps)$Breed.Group..1.) %>% 
    apply(1, function(x) any(x == 2)) # if dog's grouping are same with in each house
same.breed.group;sum(same.breed.group)
```

Here we see 39 out of 49 household have dogs in same breed group

```{r}
permanova(ps.sub, 'Household + Breed.Group..1.', 'bray')
permanova(ps.sub, 'Household + Breed.Group..1.', 'wunifrac')
```

### PERMANOVA Test by Epileptic and Control Group

Here we

```{r message=FALSE}
ps.control <- ps.sub %>% subset_samples(Epileptic.or.Control == 'Control')
ps.epileptic <- ps.sub %>% subset_samples(Epileptic.or.Control == 'Epileptic')
```

```{r}
perm.breed.bray.ctl <- permanova(ps.control, 'Breed.Group..1.', 'bray')
perm.breed.wunif.ctl <- permanova(ps.control, 'Breed.Group..1.', 'wunifrac')
perm.breed.bray.ctl;perm.breed.wunif.ctl
```

```{r}
perm.breed.bray.epi <- permanova(ps.epileptic, 'Breed.Group..1.', 'bray')
perm.breed.wunif.epi <- permanova(ps.epileptic, 'Breed.Group..1.', 'wunifrac')
perm.breed.bray.epi;perm.breed.wunif.epi
```

### Combined p value

$$X^2=-2 \sum_{i=1}^k \ln \left(p_i\right)$$

```{r}
bray.p <- c(perm.breed.bray.ctl$`Pr(>F)`[1], perm.breed.bray.epi$`Pr(>F)`[1])
# Calculate the combined p-value with fisher's method
pchisq( -2 * sum(log(bray.p)), df = 4, lower.tail = FALSE)

wunif.p <- c(perm.breed.wunif.ctl$`Pr(>F)`[1], perm.breed.wunif.epi$`Pr(>F)`[1])
# Calculate the combined p-value with fisher's method
pchisq( -2 * sum(log(wunif.p)), df = 4, lower.tail = FALSE)
```

With using the `weighted-unifrac` distance, there's at least one of the null hypothesis is rejected.

## Drug Effect

Here we are only focusing on epileptic dogs.

```{r}
plot_ord(ps.epileptic, 'Pheno.Y.N','MDS','bray')
plot_ord(ps.epileptic, 'Pheno.Y.N','MDS','wunifrac')
plot_ord(ps.epileptic, 'Pheno.Y.N','NMDS','bray')
plot_ord(ps.epileptic, 'Pheno.Y.N','NMDS','wunifrac')
```

### PERMANOVA

```{r}
permanova(ps.epileptic, 'Pheno.Y.N','bray')
permanova(ps.epileptic, 'Pheno.Y.N','wunifrac')
```

### Dispersion

```{r}
permdisp(ps.epileptic, 'Pheno.Y.N','bray')
permdisp(ps.epileptic, 'Pheno.Y.N','wunifrac')
```

```{r}
# within epileptic dogs
table(sample_data(ps)$Seizure.Freedom..Y.N., sample_data(ps)$Epileptic.or.Control)
table(sample_data(ps)$Seizure.Control..Satisfactory.Unsatisfactory., sample_data(ps)$Epileptic.or.Control)
```

## Sex Effect

Does health condition related to dog's sex? Here we conduct a Chi-squared test.

```{r}
# chisq test on epi male dog v.s. female.
# not within health condition
tb <- table(sample_data(ps)$Sex, sample_data(ps)$Epileptic.or.Control)
tb
chisq.test(tb)
```

### Ordination

```{r}
plot_ord(ps, 'Sex','MDS','bray')
plot_ord(ps, 'Sex','MDS','wunifrac')
plot_ord(ps, 'Sex','NMDS','bray')
plot_ord(ps, 'Sex','NMDS','wunifrac')
```

### PERMANOVA

```{r}
permanova(ps.sub, 'Household + Sex', 'bray')
permanova(ps.sub, 'Household + Sex', 'wunifrac')
```

### PERMDISP

```{r}
permdisp(ps.sub, 'Sex', 'bray')
permdisp(ps.sub, 'Sex', 'wunifrac')
```

## Age Effect

```{r warning=FALSE}
sam$Age..months. <- as.numeric(sam$Age..months.)
ggplot(sam) +
    geom_line(aes(x = as.numeric(Household), y = Age..months./12, group = Household)) + 
    geom_point(aes(x = as.numeric(Household), y = Age..months./12, colour = Epileptic.or.Control)) +
    xlab('Household') + ylab('Age in Year')

sam.epi <- sam %>% filter(Epileptic.or.Control == 'Epileptic')
sam.ctl <- sam %>% filter(Epileptic.or.Control == 'Control')
age.diff <- data.frame(Household = sam.epi$Household, Age.Diff = sam.epi$Age..months. - sam.ctl$Age..months.)
ggplot(age.diff) +
    geom_bar(aes(x = as.numeric(Household), y = Age.Diff/12), stat = 'identity') + 
    xlab('Household') + ylab('Age Difference in Year')
```


### PERMANOVA

```{r}
permanova(ps.sub, 'Household + Age..months.', 'bray')
permanova(ps.sub, 'Household + Age..months.', 'wunifrac')
```
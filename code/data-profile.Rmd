---
title: "Data Profile"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    self_contained: true
---

# Set up

```{r message=FALSE}
rm(list = ls())
library(here)
library(phyloseq)
library(tidyverse)
set.seed(2024)
theme_set(theme_bw())
```

# Read in data

Both pilot and following study data are loaded

```{r}
ps <- read_rds(here('data','following_study','ps_rarefied.rds'))
ps.pilot <- read_rds(here('data','pilot_study','ps_rarefied.rds'))
```

# Data Profile

```{r}
sam <- sample_data(ps) %>% data.frame()
sam <- sam %>% 
  mutate(`health condition` = Epileptic.or.Control) %>% 
  mutate(`Breed Group` = Breed.Group..1.) %>%
  mutate(`Phenobarbital Exposure` = Pheno.Y.N) %>%
  mutate(`Age (months)` = Age..months.) %>%
  dplyr::select(`health condition`, `Breed Group`, Sex, `Phenobarbital Exposure`, `Age (months)`)
```

Check frequency of breed group between health condition and perform chi-square and proportion test

```{r}
tb <- xtabs(~`Breed Group` + `health condition`, data = sam)
tb
chisq.test(tb)
prop.test(tb)
```


Check frequency of sex between health condition and perform chi-square and proportion test

```{r}
tb <- xtabs(~`Sex` + `health condition`, data = sam)
tb
chisq.test(tb)
prop.test(tb, alternative = 'greater')
```

Check frequency of Phenobarbital Exposure between health condition and perform chi-square and proportion test

```{r}
tb <- xtabs(~`Phenobarbital Exposure` + `health condition`, data = sam)
tb
```

Get distribution of Dogs age in month

```{r}
sam %>% 
  group_by(`health condition`) %>% 
  summarise(mean= mean(`Age (months)`, na.rm = TRUE), `standard deviation` = sd(`Age (months)`, na.rm = TRUE))
```

Double-check if microbial pattern is consistent with health condition. Here we draw the abundance plot by Phylum

```{r}
ps.all <- merge_phyloseq(ps, ps.pilot) %>% 
  filter_taxa(function (x) sum(x) > 100, prune = TRUE) %>%
  psmelt()
ps.all$study <- factor(ps.all$study, levels = c('pilot', 'following'))

ggplot(data = ps.all) + 
    geom_col(aes(Sample, Abundance, fill = Phylum),position = "fill", width = 1) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())  +
  facet_grid(. ~ study, scales="free_x", space="free_x")
ggsave(here('figures','abundance_phylum.png'), width = 6, height = 4)
```

```{r}
sessioninfo::session_info()
```





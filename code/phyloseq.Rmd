---
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
library(phyloseq)
library(tidyverse)
library(here)
```

```{r}
meta_data <- readRDS(here('../Rdata','metadata.rds'))
st <- readRDS(here('../Rdata', 'st_new.rds'))
taxa <- readRDS(here('../Rdata','taxsp.rds'))

str(meta_data)
# keep the matched sample ID
rownames(meta_data) <- 'Netti' %>% str_c(sprintf("%03d", as.integer(meta_data$SampleID2)))
meta_data <- meta_data[,3:12]

if(!identical(nrow(meta_data), nrow(st))) stop('meta data does not match with sequence table')
if(!identical(rownames(meta_data), rownames(st))) stop('rownames in meta data does not match with sequence table')
```

```{r}
# Get phyloseq components
OTU <- otu_table(st, taxa_are_rows = F)
SAM <- sample_data(meta_data)
TAX <- tax_table(taxa)
# Combine into a phyloseq object
ps <- phyloseq(OTU, SAM, TAX)
# Add ASV sequences
seqs <- Biostrings::DNAStringSet(taxa_names(ps))
names(seqs) <- taxa_names(ps)
ps <- merge_phyloseq(ps, seqs)
ps
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps))) # here we store 
```

```{r}
saveRDS(ps, here('Rdata','ps.rds'))
```


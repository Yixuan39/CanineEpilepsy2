---
title: "abundance plots"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
rm(list = ls())
library(here)
library(phyloseq)
library(tidyverse)
theme_set(theme_bw())
filt_fun <- function (x, min_reads = 100, min_samples = 5) {
    (sum(x) > min_reads) & (sum(x > 0) > min_samples)
}
```


```{r}
ps <- read_rds(here('data','following_study','ps.rds'))
ps.pilot <- read_rds(here('data','pilot_study','ps.rds'))
ps.all <- merge_phyloseq(ps, ps.pilot) %>% 
    filter_taxa(filt_fun, prune = TRUE)
ps.melt <- ps.all %>% psmelt()
```

Here we draw the abundance plot by Phylum

```{r}
ps.melt$study <- factor(ps.melt$study, levels = c('pilot', 'following'))

ggplot(data = ps.melt) + 
    geom_col(aes(Sample, Abundance, fill = Phylum),position = "fill", width = 1) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())  +
  facet_grid(. ~ study, scales="free_x", space="free_x")
ggsave(here('figures','abundance_phylum.png'), width = 6, height = 4)
```

Here we start to look at the relative abundance by Genus in each of Actinobacteriota, Bacteroidota, Fusobacteriota, and Proteobacteria

```{r}
ggplot(data = ps.melt %>% filter(Phylum == 'Actinobacteriota')) + 
    geom_col(aes(Sample, Abundance, fill = Genus),position = "fill", width = 1) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())  +
  facet_grid(. ~ study, scales="free_x", space="free_x")

ggplot(data = ps.melt %>% filter(Phylum == 'Bacteroidota')) + 
    geom_col(aes(Sample, Abundance, fill = Genus),position = "fill", width = 1) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())  +
  facet_grid(. ~ study, scales="free_x", space="free_x")

ggplot(data = ps.melt %>% filter(Phylum == 'Fusobacteriota')) + 
    geom_col(aes(Sample, Abundance, fill = Genus),position = "fill", width = 1) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())  +
  facet_grid(. ~ study, scales="free_x", space="free_x")

ggplot(data = ps.melt %>% filter(Phylum == 'Proteobacteria')) + 
    geom_col(aes(Sample, Abundance, fill = Genus),position = "fill", width = 1) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())  +
  facet_grid(. ~ study, scales="free_x", space="free_x")
```

```{r}
sessionInfo()
```





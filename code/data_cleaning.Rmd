---
title: "metadata cleaning"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
rm(list = ls())
set.seed(2024)
library(tidyverse)
library(readxl)
library(here)
library(phyloseq)
```

# Check Metadata

```{r}
file <- 'Epilepsy study mapping file with patient info updated 1.22.24 for microbiome analysis.xlsx'
meta_data <- read_excel(here('data', 'following_study', file), 
                        n_max = 118,
                        na = '.') %>%
    arrange(str_rank(Household, numeric = T))
# the sample id2 column was in float, we we change it to integer
str(meta_data)
meta_data$Household <- meta_data$Household %>% 
    as.character()
meta_data$`Age (months)` <- meta_data$`Age (months)` %>%
    str_remove('\\.0') %>% 
    as.numeric()
meta_data$`Zip Code` <- meta_data$`Zip Code` %>%
    str_remove('\\.0') %>%
    str_replace('O','0')
# remove comments row in excel
meta_data <- meta_data %>% dplyr::select(-COMMENTS) %>% data.frame()
# match sample name same as that in the asv table
rownames(meta_data) <- 'Netti' %>%
    str_c(sprintf("%03d", as.integer(meta_data$SampleID2)))
meta_data <- meta_data %>% add_column(study = 'following')
```
Separate sex variable

```{r}
table(meta_data$Sex)
```

```{r}
meta_data <- meta_data %>%
    separate(Sex, into = c("Sex", "Reproductive.Status"), sep = 1) %>% 
    mutate(Spayed.or.Neutered = (Reproductive.Status != 'I'))
```

There are NAs in Pheno.Y.N. Here we fill NA with No, since those are dogs in control group

```{r}
meta_data$Pheno.Y.N[is.na(meta_data$Pheno.Y.N)] <- 'No'
```


# Integrate data with phyloseq

```{r}
st <- readRDS(here('data','following_study','st.rds'))
taxa <- readRDS(here('data','following_study','taxsp.rds'))

# match st order with metadata (since metadata is sorted by household)
st <- st[meta_data$SampleID2,]
if(!identical(nrow(meta_data), nrow(st))) stop('meta data does not match with sequence table')
if(!identical(rownames(meta_data), rownames(st))) stop('rownames in meta data does not match with sequence table')
# create a phyloseq object
ps <- phyloseq(sample_data(meta_data),
               otu_table(st, taxa_are_rows = FALSE),
               tax_table(taxa))

# Add ASV sequences
seqs <- Biostrings::DNAStringSet(taxa_names(ps))
names(seqs) <- taxa_names(ps)
ps <- merge_phyloseq(ps, seqs)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps))) 
```

# Quality Assurance

Do some QA on the sequencing libraries:

```{r}
plot(rowSums(st), log="y")
which(rowSums(st) < 2e+3)
which(rowSums(st) < 100)
```

All of the data has more than 100 reads, but sample 40,80 and 108 have relative low sequencing depth.

**remove duplicated samples**

For household 52

sample 106,107,108 are duplicates of sample 103. sample 105 is the duplicate of sample 104.

```{r}
rowSums(st)[str_c('Netti',c('103','106','107','108'))] %>% sort()
rowSums(st)[str_c('Netti',c('104','105'))] %>% sort()
```

Here we can keep sample 103 since it has more reads.

For household 54

sample 63,113,115 are duplicates of sample 114. sample 64,117,118 are duplicates of sample 116.

```{r}
rowSums(st)[str_c('Netti',c('063','113','114','115'))] %>% sort()
rowSums(st)[str_c('Netti',c('064','116','117','118'))] %>% sort()
```

Here we can keep the sample with most reads (sample 64 and 114)

# Clean Metadata

For now we can remove sample 106,107,108,113,115,63,116,117,118.

```{r}
remove.list <- c(104,106,107,108,113,115,63,116,117,118)

ps <- ps %>% 
    subset_samples(!(SampleID2 %in% remove.list))
```

For households that have more than two samples, we will remove the exceed samples and make them into pairs.

```{r}
n.samples <- table(sample_data(ps)$Household)
n.samples[n.samples != 2]
```

There are 4 dogs in household 17, 18, and 26.

```{r}
exceed.samples <- sample_data(ps) %>%
    data.frame() %>% 
    filter(Household %in% c(17,18,26)) %>%
    arrange(Household) %>%
    dplyr::select(SampleID2, Household, Epileptic.or.Control)
exceed.samples
```

Take a look at the sequencing depth of these samples

```{r}
rowSums(st)[exceed.samples$SampleID2]
```


Remove exceeded samples to make a paired data.

```{r}
remove.list <- c(110,111,9,10,37,38)
ps <- ps %>% 
    subset_samples(!(SampleID2 %in% remove.list))
ps
```

Now we have 102 samples (data are paired within 51 households)

# Align Sequences

```{r, eval = FALSE}
alignment <- DECIPHER::AlignSeqs(refseq(ps), anchor=NA)
alignment.file <- here('data', 'following_study', 'msa.fasta')
Biostrings::writeXStringSet(alignment, alignment.file)
```

Here we use `raxml-ng` to find the best tree of the alignment

```{bash, eval = FALSE}
raxml-ng --msa data/following_study/msa.fasta --model GTR+G --prefix data/following_study/tree --seed 2024
```

```{r}
best.tree <- read_tree(here('data','following_study','tree.raxml.bestTree'))
ps <- merge_phyloseq(ps, phy_tree(best.tree))
# order phyloseq data by household
# ps <- microViz::ps_arrange(ps, str_rank(Household, numeric = TRUE))
if (!identical(rownames(otu_table(ps)), rownames(sample_data(ps)))) stop('sample names are not matched!')
```

# Rarefied Data

The sequencing depth for each sample is different, we need to check and bring them to the same level.

```{r}
# check distribution of sequencing depth
sample_sums(ps) %>% hist()
sample_sums(ps) %>% sort() %>% head()
```

Here, we see most of sample has sequencing depth greater than 40000, we can bring all the samples to this sequencing depth level, and drop the two samples (Netti040 and Netti080) that have low sequencing depth.


```{r message=FALSE}
# make read depth even
ps.rarefied <- rarefy_even_depth(ps, sample.size = 44590)
ps.rarefied
```

Two samples are lost after rarefying. Now we have 98 samples.

```{r message=FALSE}
house.rm <- meta_data[c('Netti040','Netti080'),'Household']
house.rm
ps.rarefied <- ps.rarefied %>% 
    subset_samples(!(Household %in% house.rm))
ps.rarefied
```

# Save Data

```{r}
saveRDS(ps, file = here('data','following_study','ps.rds'))
saveRDS(ps.rarefied, file = here('data','following_study','ps_rarefied.rds'))
```





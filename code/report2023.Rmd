---
title: "Canine Epilepsy"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r message=FALSE}
set.seed(2023)
library(here)
library(phyloseq)
library(tidyverse)
library(ALDEx2)
library(knitr)
theme_set(theme_bw())
```

```{r}
filt_fun <- function (x, min_reads = 100, min_samples = 5) {
    (sum(x) > min_reads) & (sum(x > 0) > min_samples)
}
fitGTR <- readRDS(here('Rdata','following_study','fitGTR.rds'))
ps <- readRDS(here('Rdata','following_study','ps.rds')) %>% 
     filter_taxa(filt_fun, prune = TRUE) 
sam <- sample_data(ps) %>% data.frame() %>%
    rownames_to_column('Sample') %>% as_tibble()
tax <- tax_table(ps) %>% data.frame() %>%
    rownames_to_column('Taxon') %>% as_tibble
# convert data into proportion
ps.prop <- readRDS(here('Rdata','following_study','ps.rds')) %>%
    merge_phyloseq(phy_tree(fitGTR$tree)) %>% 
    filter_taxa(filt_fun, prune = TRUE) %>% 
    transform_sample_counts(function(x) x / sum(x) )
# pilot study data
ps.pilot <- read_rds(here('Rdata','pilot_study','ps.rds')) %>% 
    filter_taxa(filt_fun, prune = TRUE)
```

# Abundance Plot

Here we compare the global patterns of canine's microbiome between the pilot and following study, and find there's no big difference.

```{r}
abundance.data <- merge_phyloseq(ps, ps.pilot) %>% psmelt()
abundance.data$study <- factor(abundance.data$study,
                               levels = c('pilot', 'following'))

ggplot(data = abundance.data) + 
    geom_col(aes(Sample, Abundance, fill = Phylum),
             position = "fill", width = 1) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())  +
  facet_grid(. ~ study, scales="free_x", space="free_x")
```

# Sample Distribution

Here we list the variables we have in the following study, and we want to check if `Household`, `State`, and `drug usage` are strong factors that affect dog's microbiome in general using `PERMANOVA` test.

```{r}
colnames(sample_data(ps))
```

## PERANOVA test

**household**

The dogs microbiome are significantly different (p<0.05) across different households.

```{r}
bc <- phyloseq::distance(ps.prop, method="bray")
samdf.ord <- data.frame(sample_data(ps.prop))
vegan::adonis2(bc ~ Household, data = samdf.ord, permutations=1e4)
```

**State**

State is also a significant factor (p<0.05). It could be interpret as a different version of `Household` variable

```{r}
vegan::adonis2(bc ~ State.Infor, data = samdf.ord, permutations=1e4)
```

**A visual distribution of samples across states**

```{r}
library(usmap)
all.states <- us_map()$full %>% unique
state.info <- data.frame(sample_data(ps)) %>%
    count(State.Infor) %>% 
    data.frame()

for (i in all.states) {
    if (!(i %in% state.info[,1])){
        state.info <- state.info %>% rbind(c(i, 0))
    }
}
colnames(state.info) <- c('state', 'values')
state.info$values <- as.numeric(state.info$values)

plot_usmap(data = state.info) +
    scale_fill_continuous(low = "white", high = "blue") +
    ggtitle('Sample distribution in the US')
```

**Drug usage**

Does taking drug affect dog's microbiome? Here we only look at dogs that have epilepsy.

```{r}
ps.prop.epi <- ps.prop %>% subset_samples(Epileptic.or.Control == "Epileptic")
bc.epi <- phyloseq::distance(ps.prop.epi, method="bray")
samdf.ord.epi <- data.frame(sample_data(ps.prop.epi))
vegan::adonis2(bc.epi ~ Pheno.Y.N, data = samdf.ord.epi, permutations=1e4)
```

# Differential Abundance

In this section, we are going to find what ASVs are different in different condition. Here, we use the `ALDEx2` package. In the table below, we conduct pair-wise t-test to see which ASVs are different between the healthy and epileptic dogs. `we.ep` and `we.eBH` are the p-value and the corrected p-value of the Welch' t-test. 

```{r message=FALSE}
aldex.tt <- aldex(otu_table(ps) %>% t, sam$Epileptic.or.Control,
                  test="t", verbose=FALSE, paired.test=TRUE,
                  effect=TRUE , mc.samples = 128,
                  denom = "all", useMC = TRUE) %>%
    as_tibble(rownames = "Taxon")
aldex.tt%>%
    left_join(tax, by = "Taxon") %>%
    filter(we.ep < 0.1) %>% 
    dplyr::select(Taxon, effect, starts_with("we"), Phylum, Genus) %>% 
    kable()
```

Which ASVs are different when dog have eplileptic drug? (Only epileptic dogs are included in this test)

```{r message=FALSE}
# change only for epi dogs
ps.epi <- ps %>% subset_samples(Epileptic.or.Control == "Epileptic")
aldex.tt <- aldex(otu_table(ps.epi) %>% t, sample_data(ps.epi)$Pheno.Y.N,
                  test="t", verbose=FALSE, paired.test=FALSE,
                  effect=TRUE , mc.samples = 128, denom = "all", useMC = TRUE) %>%
    as_tibble(rownames = "Taxon")
aldex.tt%>%
    left_join(tax, by = "Taxon") %>%
    filter(we.ep < 0.1) %>% 
    dplyr::select(Taxon, effect, starts_with("we"), Phylum, Genus) %>% 
    kable()
```

We noticed that `State`/`Household` is a strong factor that affect the dog's microbiome. To bring each individual dogs to the same level, we build a linear regression model with `Pheno.Y.N` and `State.Infor`. When we control the drug usage and location, only `ASV2` is different between the healthy and epileptic dogs.

```{r results='hide', message=FALSE}
mm <- model.matrix( ~ Epileptic.or.Control + Pheno.Y.N + State.Infor,  sam)
x <- aldex.clr(otu_table(ps) %>% t, 
    mm, mc.samples = 128, denom = "all", useMC = TRUE)
glm.test <- aldex.glm(x, mm)
glm.effect <- aldex.glm.effect(x, useMC = TRUE)
```

```{r}
sig <- glm.test$`Epileptic.or.ControlEpileptic:pval` < 0.1
glm.test[sig,] %>%
    rownames_to_column('Taxon') %>%
    as_tibble() %>%
    left_join(tax, by = 'Taxon') %>% 
    dplyr::select('Taxon','Epileptic.or.ControlEpileptic:pval',
                  'Phylum', 'Genus') %>% 
    kable()
```

# Lactobacillus and Helicobacter

Lactobacillus and helicobacter are two genus that we are interested in. From the results above, we didn't find them to be significant. Here we want to look at how their data are distributed. In *Figure1*, we showed the pattern of Helicobacter and Lactobacillus for the control and eplipetic group across different households in genus level. It turns out for different household, these two genus could be distributed very differently.

```{r message=FALSE, fig.cap='Proportion of Helicobacter and Lactobacillus Across Households'}
ps.interest <- subset_taxa(ps.prop, Genus %in%
                               c('Lactobacillus', 'Helicobacter'))
otu.interest <- otu_table(ps.interest)
genus.interest <- data.frame(tax_table(ps.interest))$Genus
otu.prop.interest <- data.frame(Group = factor(sam$Epileptic.or.Control),
                                Household = sam$Household,
                                otu.interest) %>% 
    gather(key = 'Taxon', value = 'proportion', starts_with('ASV')) %>% 
    mutate(TH = str_c(Taxon, Household, sep = '_')) %>% 
    mutate(Genus = tax_table(ps.interest)[Taxon, 'Genus'])
otu.prop.interest$Household <- 
    factor(otu.prop.interest$Household,
           levels = str_sort(unique(otu.prop.interest$Household), numeric = T))

ggplot(data = otu.prop.interest,
       aes(x = Group, y = proportion, group = TH, color = Household)) +
    geom_point() +
    geom_line() +
    facet_wrap(~Genus, scales = 'free_y')
```

Just in case, we can also look at the plot in ASV level

```{r message=FALSE}
ggplot(data = otu.prop.interest,
       aes(x = Group, y = proportion, group = TH, color = Household)) +
    geom_point() +
    geom_line() +
    facet_wrap(~Genus + Taxon, scales = 'free_y')
```

We notice that some of the samples have very low abundance of Lactobacillus and Helicobactor. Here we count if these two genus are even detected across samples. We see only around 1/5 of the dogs have Lactobaccilus in their guts.

```{r message=FALSE, warning=FALSE}
exist.lac <- ps %>%
    subset_taxa(Genus == 'Lactobacillus') %>% 
    otu_table() %>%
    rowSums() %>% 
    as.data.frame() %>% 
    mutate(exist = if_else(.==0, FALSE, TRUE)) %>% 
    mutate(Genus = 'Lactobacillus') %>% 
    mutate(Condition = sam$Epileptic.or.Control)

exist.heli <- ps %>%
    subset_taxa(Genus == 'Helicobacter') %>% 
    otu_table() %>%
    rowSums() %>% 
    as.data.frame() %>% 
    mutate(exist = if_else(.==0, FALSE, TRUE)) %>% 
    mutate(Genus = 'Helicobacter') %>% 
    mutate(Condition = sam$Epileptic.or.Control)

ggplot(data = bind_rows(exist.lac, exist.heli), aes(x = exist))+
    geom_histogram(stat = 'count') +
    facet_wrap(~Genus + Condition)
# ggsave('count_plot.png')
# require(gt)
# bind_rows(exist.lac, exist.heli) %>% 
#   group_by(Genus,Condition) %>% 
#   count(exist) %>% 
#   ungroup() %>% 
#   gt() %>% gtsave(filename = 'count_table.png')
```


# Principal Coordinates Analysis (PCoA)

Here we look at the similarity of each object. We can see the difference of each object is smaller within each household.

```{r}
# OTU table is in proportion in this situation
plot.ord <- function(psi, ordi, color='Epileptic.or.Control',
                     label="Household", size=3, axes=c(1,2)) {
  p <- plot_ordination(psi, ordi, axes=axes)
  ggplot(data=p$data, aes_string(x=quo_name(p$mapping$x), 
                                 y=quo_name(p$mapping$y), 
                                 color=color, label=label)) + 
      geom_text(size=size, check_overlap = T)
}

ps.uf <- UniFrac(ps.prop)
pcoa <- ordinate(ps.prop, method="PCoA", distance=ps.uf)
plot.ord(ps.prop, pcoa)
```

The plot shows a clear pattern of two clusters. Does it related to geographic location?

```{r}
plot.ord(ps.prop, pcoa, label = 'State.Infor')
```


---
title: "DA-analysis"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

# Set Up

```{r}
set.seed(255)
library(tidyverse)
library(ALDEx2)
library(ANCOMBC)
library(corncob)
library(MicrobiomeStat)
library(rstatix)
library(phyloseq)
library(here)
library(future.apply);plan(multisession)
filt_fun <- function (x, min_reads = 100, min_samples = 5) {
    (sum(x) > min_reads) & (sum(x > 0) > min_samples)
}

ps <- readRDS(here('data','following_study','ps.rds')) %>% 
    filter_taxa(filt_fun, prune = TRUE)
ps.rare <- readRDS(here('data','following_study','ps_rarefied.rds')) %>% 
    filter_taxa(filt_fun, prune = TRUE)
tax <- tax_table(ps)
alpha <- 0.05
max.cores <- parallel::detectCores()
ps;ps.rare
```


# T-test

The design of this study is paired by household, and we want use t-test to compare dogs within households. Here we check if the data is really paired.

```{r}
# check if data are paired
if (!identical(sample_data(ps)$Household[seq(1,102,2)],
               sample_data(ps)$Household[seq(1,102,2)+1])) stop('data is not paired')
if (!identical(sample_data(ps.rare)$Household[seq(1,98,2)],
               sample_data(ps.rare)$Household[seq(1,98,2)+1])) stop('rarefied data is not paired')
```


## ALDEx2 pairwise T-test

```{r}
# aldex pairwise t test
# central log ratio transformed data
x <- aldex.clr(t(otu_table(ps)), sample_data(ps)$Epileptic.or.Control, mc.samples=128, denom="all", useMC = TRUE)
aldex.tt <- aldex.ttest(x, paired.test = TRUE)
aldex.tt.res <- aldex.tt[aldex.tt$we.ep < alpha,] %>% 
    rownames_to_column('taxon')
tax[aldex.tt.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
```

## regular pairwise T-test on rarefied data

```{r}
paired.data <- bind_cols(data.frame(sample_data(ps.rare)),
                         data.frame(otu_table(ps.rare)))
pair.t.test <- function(ASV, group = 'Epileptic.or.Control', data = paired.data) {
    formula <- as.formula(str_c(ASV, '~', group, sep = ' '))
    result <- pairwise_t_test(formula, data = data, paired = TRUE)
    p.value <- result$p
    return(p.value)
}
paired.tt <- future_sapply(taxa_names(ps.rare), pair.t.test)

paired.tt.res <- paired.tt[which(paired.tt < alpha)] %>% 
    data.frame() %>% 
    rownames_to_column('taxon')
tax[paired.tt.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
```

# Differential Abundance Test With GLM

We have found that the `Household` could be a strong factor that affect dogs' microbiome. To remove the effect of `Household` we propose this model:

$$ASV_i \sim Epileptic.or.Control + Household$$

## ALDEx2 GLM

```{r}
# Construct model matrix
model <- model.matrix(~ Epileptic.or.Control + Household, data.frame(sample_data(ps)))

# Perform CLR transformation and Monte Carlo sampling
x <- aldex.clr(t(otu_table(ps)), model, mc.samples=128, denom="all", useMC = TRUE, verbose = FALSE)
aldex.glm <- aldex.glm(x, model)
```

```{r}
aldex.glm.res <- aldex.glm[aldex.glm$`Epileptic.or.ControlEpileptic:pval` < alpha,] %>% 
    rownames_to_column('taxon')
tax[aldex.glm.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
```

## ANCOMBC

```{r, message=FALSE}
ancombc.da <- ancombc(data = ps,
                      formula = 'Epileptic.or.Control + Household',
                      n_cl = max.cores)
```

```{r}
ancombc.res <- ancombc.da$res$p_val %>% 
    filter(Epileptic.or.ControlEpileptic < alpha) 

tax_table(ps)[ancombc.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
```

## corncob

```{r}
corncob.da <- differentialTest(formula= ~ Epileptic.or.Control + Household,
                              formula_null = ~ Household,
                              phi.formula = ~ 1,
                              phi.formula_null = ~ 1,
                              taxa_are_rows = FALSE,
                              test="Wald",
                              data=ps,
                              boot=FALSE)
```

```{r}
corncob.res <- corncob.da$p[which(corncob.da$p < alpha)] %>% 
    data.frame() %>% 
    rownames_to_column('taxon')
tax[corncob.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
```

## LinDA

```{r}
linda.da <- linda(t(data.frame(otu_table(ps))),
                   data.frame(sample_data(ps)),
                   formula = '~ Epileptic.or.Control + Household',
                   feature.dat.type = 'count',
                   n.cores = max.cores,
                   verbose = TRUE)

```

```{r}
linda.res <- linda.da$output$Epileptic.or.ControlEpileptic %>% 
    filter(pvalue < alpha) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
tax[linda.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
```

# Summary

```{r}
summary.table <- data.frame(taxon = str_sort(taxa_names(ps), numeric = TRUE)) %>% 
    mutate(aldex.t.test = taxon %in% aldex.tt.res$taxon) %>% 
    mutate(paired.t.test = taxon %in% paired.tt.res$taxon) %>% 
    mutate(aldex.glm = taxon %in% aldex.glm.res$taxon) %>% 
    mutate(ANCOMBC = taxon %in% ancombc.res$taxon) %>% 
    mutate(corncob = taxon %in% corncob.res$taxon) %>% 
    mutate(LinDA = taxon %in% linda.res$taxon)
keep <- which(rowSums(summary.table %>% dplyr::select(-taxon)) >= 3)
summary.table[keep,]
```


```{r}
sessionInfo()
```


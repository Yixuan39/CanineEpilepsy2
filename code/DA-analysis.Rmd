---
title: "DA-analysis"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

# Set Up

```{r, message=FALSE}
set.seed(255)
library(tidyverse)
library(ALDEx2)
library(ANCOMBC)
library(corncob)
library(MicrobiomeStat) # for linDA
library(phyloseq)
library(here)
library(gt)
theme_set(theme_bw())
filt_fun <- function (x, min_reads = 100, min_samples = 5) {
    (sum(x) > min_reads) & (sum(x > 0) > min_samples)
}

ps <- readRDS(here('data','following_study','ps.rds')) %>% 
    filter_taxa(filt_fun, prune = TRUE)
ps.rare <- readRDS(here('data','following_study','ps_rarefied.rds')) %>% 
    filter_taxa(filt_fun, prune = TRUE)
tax <- tax_table(ps)
alpha <- 0.05
max.cores <- parallel::detectCores()
p.value.tb <- data.frame(taxon = taxa_names(ps))
ps;ps.rare
```


# T-test

The design of this study is paired by household, and we want use t-test to compare dogs within households. Here we check if the data is really paired.

```{r}
# check if data are paired
if (!identical(sample_data(ps)$Household[seq(1,102,2)],
               sample_data(ps)$Household[seq(1,102,2)+1])) stop('data is not paired')
if (!identical(sample_data(ps.rare)$Household[seq(1,98,2)],
               sample_data(ps.rare)$Household[seq(1,98,2)+1])) stop('rarefied data is not paired')
```


## ALDEx2 pairwise T-test

```{r}
# aldex pairwise t test
# central log ratio transformed data
x <- aldex.clr(t(otu_table(ps)), sample_data(ps)$Epileptic.or.Control, mc.samples=128, denom="all")
aldex.tt <- aldex.ttest(x, paired.test = TRUE) %>% 
    cbind(aldex.effect(x, CI = TRUE, paired.test = TRUE)) %>% 
    rownames_to_column('taxon')
aldex.tt.res <- aldex.tt[aldex.tt$we.ep < alpha,]
tax[aldex.tt.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    cbind(log2fold = aldex.tt.res$diff.btw,
          p = aldex.tt.res$we.ep) %>% 
    rownames_to_column('taxon') -> aldex.tt.res
gt(aldex.tt.res)
p.value.tb <- p.value.tb %>% 
    full_join(aldex.tt, by = 'taxon') %>% 
    mutate(aldex.tt = we.ep) %>% 
    dplyr::select(taxon,aldex.tt)
```

## regular pairwise T-test on rarefied data

```{r}
paired.data <- bind_cols(data.frame(sample_data(ps.rare)),
                         data.frame(otu_table(ps.rare)))
paired.data.x <- paired.data[which(paired.data$Epileptic.or.Control == 'Epileptic'),]
paired.data.y <- paired.data[which(paired.data$Epileptic.or.Control == 'Control'),]
# check if data are paired
if(!identical(paired.data.x$Household, paired.data.y$Household)) stop('paired data household not equal')

pair.t.test <- function(ASV, group = 'Epileptic.or.Control', data.x = paired.data.x, data.y = paired.data.y) {
    x <- paired.data.x[,ASV]
    y <- paired.data.y[,ASV]
    lfc <- mean(log2(x+1))-mean(log2(y+1)) # calculate log2 fold change
    result <- t.test(x,y, paired = TRUE, alternative = 'two.sided')
    p.value <- result$p.value
    return(c(lfc, p.value))
}
paired.tt <- t(sapply(taxa_names(ps.rare), pair.t.test)) %>% 
    data.frame() %>% 
    rownames_to_column('taxon')
colnames(paired.tt)[2:3] <- c('log2fold', 'paired.tt')

paired.tt.res <- paired.tt[paired.tt$paired.tt < alpha,]
tax[paired.tt.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    cbind(log2fold = paired.tt.res$log2fold, p = paired.tt.res$paired.tt) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE)) -> paired.tt.res
gt(paired.tt.res)
p.value.tb <- p.value.tb %>% 
    full_join(paired.tt, by = 'taxon') %>% 
    dplyr::select(taxon, aldex.tt, paired.tt)
```

# Differential Abundance Test With GLM

We have found that the `Household` could be a strong factor that affect dogs' microbiome. To remove the effect of `Household` we propose this model:

$$ASV_i \sim Epileptic.or.Control + Household$$

## ALDEx2 GLM

```{r}
# Construct model matrix
model <- model.matrix(~ Epileptic.or.Control + Household, data.frame(sample_data(ps)))

# Perform CLR transformation and Monte Carlo sampling
x <- aldex.clr(t(otu_table(ps)), model, mc.samples=128, denom="all", verbose = FALSE)
aldex.glm <- aldex.glm(x, model) %>% 
    cbind(aldex.glm.effect(x, CI = TRUE, verbose = FALSE)) %>% 
    rownames_to_column('taxon')
```

```{r}
aldex.glm.res <- aldex.glm[aldex.glm$`Epileptic.or.ControlEpileptic:pval` < alpha,] 
tax[aldex.glm.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    cbind(log2fold = aldex.glm.res$Epileptic.or.ControlEpileptic.diff.btw,
          p = aldex.glm.res$`Epileptic.or.ControlEpileptic:pval`) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE)) -> aldex.glm.res
gt(aldex.glm.res)

p.value.tb <- p.value.tb %>% 
    full_join(aldex.glm %>% dplyr::select(taxon,`Epileptic.or.ControlEpileptic:pval`), by = 'taxon') %>% 
    rename(aldex.glm = `Epileptic.or.ControlEpileptic:pval`)
    
```

## ANCOMBC

```{r, message=FALSE}
ancombc.da <- ancombc(data = ps,
                      formula = 'Epileptic.or.Control + Household',
                      n_cl = max.cores)
```

```{r}
ancombc.res <- ancombc.da$res$p_val %>% 
    filter(Epileptic.or.ControlEpileptic < alpha) 

tax_table(ps)[ancombc.res$taxon,] %>% 
    data.frame() %>% 
    rownames_to_column('taxon') %>% 
    #arrange(str_rank(taxon, numeric = TRUE)) %>% 
    left_join(ancombc.da$res$lfc, by = 'taxon') %>% 
    mutate(log2fold = log2(exp(Epileptic.or.ControlEpileptic))) %>% # convert natural log to log2
    dplyr::select(taxon,Phylum, Genus, log2fold) %>% 
    left_join(ancombc.da$res$p_val, by = 'taxon') %>% 
    mutate(p = Epileptic.or.ControlEpileptic) %>% 
    dplyr::select(taxon,Phylum, Genus, log2fold,p) -> ancombc.res
gt(ancombc.res)

p.value.tb <- p.value.tb %>% 
    full_join(ancombc.da$res$p_val %>% dplyr::select(taxon,Epileptic.or.ControlEpileptic), by = 'taxon') %>% 
    rename(ancombc = Epileptic.or.ControlEpileptic)
```

## corncob

```{r}
corncob.da <- differentialTest(formula= ~ Epileptic.or.Control + Household,
                               phi.formula = ~ 1,
                               formula_null = ~ Household,
                               phi.formula_null = ~ 1,
                               test = 'Wald',
                               data = ps,
                               taxa_are_rows = FALSE)
```

```{r}
# convert corcob result to log2fold difference
corncob.summary <- function(corncob.da, i) {
    regression.result <- corncob.da$all_models[[i]]$coefficients
    ps <- corncob.da$data
    read.depth <- rowSums(otu_table(ps))
    treatment.name <- ps %>% sample_data() %>% data.frame() %>% filter(Epileptic.or.Control == 'Epileptic') %>% rownames()
    control.name <- ps %>% sample_data() %>% data.frame() %>% filter(Epileptic.or.Control == 'Control') %>% rownames()
    read.depth.treatment <- read.depth[treatment.name]
    read.depth.control <- read.depth[control.name]
    # p value
    p <- corncob.da$all_models[[i]]$coefficients['mu.Epileptic.or.ControlEpileptic','Pr(>|t|)']
    # relative abundance
    control.ra <- regression.result['mu.(Intercept)','Estimate'] %>% invlogit()
    treatment.ra <- regression.result[c('mu.(Intercept)','mu.Epileptic.or.ControlEpileptic'),'Estimate'] %>% sum() %>% invlogit()
    ra.diff <- treatment.ra - control.ra
    log2fold <- log2((mean(read.depth.treatment)*treatment.ra) / (mean(read.depth.control)*control.ra))
    summary <- c(log2fold,ra.diff,p)
    return(summary)
}
corncob.sum.tb <- sapply(1:length(taxa_names(ps)), function(i) corncob.summary(corncob.da, i)) %>% t() %>% data.frame()
rownames(corncob.sum.tb) <- taxa_names(ps)
colnames(corncob.sum.tb) <- c('log2fold','ra.diff','p')
```


```{r}
corncob.taxa <- names(corncob.da$p[which(corncob.da$p < alpha)])
# p value in the table is term specific, but significance is determined by wald test
corncob.res <- data.frame(tax[,c(2,6)], corncob.sum.tb)[corncob.taxa,] %>% rownames_to_column('taxon')
gt(corncob.res)

p.value.tb <- p.value.tb %>% 
    full_join(corncob.sum.tb %>% rownames_to_column('taxon'), by = 'taxon') %>% 
    rename(corncob = p) %>% 
    dplyr::select(-c(log2fold, ra.diff))
```

## LinDA

```{r}
linda.da <- linda(t(data.frame(otu_table(ps))),
                   data.frame(sample_data(ps)),
                   formula = '~ Epileptic.or.Control + Household',
                   feature.dat.type = 'count',
                   n.cores = max.cores,
                   verbose = FALSE)
```

```{r}
linda.res <- linda.da$output$Epileptic.or.ControlEpileptic %>% 
    filter(pvalue < alpha) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
tax[linda.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    cbind(log2fold = linda.res$log2FoldChange, p = linda.res$pvalue) %>% 
    rownames_to_column('taxon') -> linda.res
gt(linda.res)
p.value.tb <- p.value.tb %>% 
    full_join(linda.da$output$Epileptic.or.ControlEpileptic %>%
                  rownames_to_column('taxon') %>% 
                  dplyr::select(taxon,pvalue), by = 'taxon') %>% 
    rename(linda = pvalue)
```

# Summary

```{r}
summary.table <- data.frame(taxon = str_sort(taxa_names(ps), numeric = TRUE)) %>% 
    mutate(aldex.t.test = taxon %in% aldex.tt.res$taxon) %>% 
    mutate(paired.t.test = taxon %in% paired.tt.res$taxon) %>% 
    mutate(aldex.glm = taxon %in% aldex.glm.res$taxon) %>% 
    mutate(ANCOMBC = taxon %in% ancombc.res$taxon) %>% 
    mutate(corncob = taxon %in% corncob.res$taxon) %>% 
    mutate(LinDA = taxon %in% linda.res$taxon)
keep <- which(rowSums(summary.table %>% dplyr::select(-taxon)) >= 3)
summary.table[keep,] %>% gt
```

```{r}
# fold change
fold.change <- bind_rows(list(`aldex.tt.lfc(median)` = aldex.tt.res,
                              paired.tt.lfc = paired.tt.res,
                              `aldex.glm.lfc(median)` = aldex.glm.res,
                              ancombc.lfc = ancombc.res,
                              corncob.lfc = dplyr::select(corncob.res, -ra.diff),
                              corncob.ra.diff = dplyr::select(corncob.res, -log2fold) %>% mutate(log2fold = ra.diff),
                              linDA.lfc = linda.res), .id = 'method') %>% 
    filter(taxon %in% summary.table[keep,'taxon']) %>% 
    rename(difference = log2fold) %>% 
    mutate(direction = if_else(difference > 0, 'positive', 'negative')) 
fold.change$taxon <- factor(fold.change$taxon, levels = unique(str_sort(fold.change$taxon, numeric = TRUE)))

ggplot(fold.change) +
    geom_bar(aes(x = taxon, y = difference, fill = direction), stat = 'identity', width = 0.7) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    facet_wrap(~method, scales = 'free_y')
```

correlation of p-value for each method (except for corncob).

```{r}
cor(p.value.tb %>% column_to_rownames('taxon') %>% na.omit())
```



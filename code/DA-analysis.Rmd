---
title: "DA-analysis"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output: html_document
---

# Set Up

```{r, message=FALSE}
set.seed(255)
library(tidyverse)
library(ALDEx2)
library(ANCOMBC)
library(corncob)
library(MicrobiomeStat) # for linDA
library(phyloseq)
library(here)
library(gt)
theme_set(theme_bw())
filt_fun <- function (x, min_reads = 100, min_samples = 5) {
    (sum(x) > min_reads) & (sum(x > 0) > min_samples)
}

ps <- readRDS(here('data','following_study','ps.rds')) %>% 
    filter_taxa(filt_fun, prune = TRUE)
ps.rare <- readRDS(here('data','following_study','ps_rarefied.rds')) %>% 
    filter_taxa(filt_fun, prune = TRUE)
tax <- tax_table(ps)
alpha <- 0.05
max.cores <- parallel::detectCores()
ps;ps.rare
```


# T-test

The design of this study is paired by household, and we want use t-test to compare dogs within households. Here we check if the data is really paired.

```{r}
# check if data are paired
if (!identical(sample_data(ps)$Household[seq(1,102,2)],
               sample_data(ps)$Household[seq(1,102,2)+1])) stop('data is not paired')
if (!identical(sample_data(ps.rare)$Household[seq(1,98,2)],
               sample_data(ps.rare)$Household[seq(1,98,2)+1])) stop('rarefied data is not paired')
```


## ALDEx2 pairwise T-test

```{r}
# aldex pairwise t test
# central log ratio transformed data
x <- aldex.clr(t(otu_table(ps)), sample_data(ps)$Epileptic.or.Control, mc.samples=128, denom="all")
aldex.tt <- aldex.ttest(x, paired.test = TRUE) %>% 
    cbind(aldex.effect(x, CI = TRUE, paired.test = TRUE)) %>% 
    rownames_to_column('taxon')
tax[aldex.tt$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    cbind(log2fold = aldex.tt$diff.btw,
          p = aldex.tt$we.ep) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE)) -> aldex.tt.res
aldex.tt.res %>% filter(p <= alpha) %>% gt()
```

## regular pairwise T-test on rarefied data

```{r}
paired.data <- bind_cols(data.frame(sample_data(ps.rare)),
                         data.frame(otu_table(ps.rare)))
paired.data.x <- paired.data[which(paired.data$Epileptic.or.Control == 'Epileptic'),]
paired.data.y <- paired.data[which(paired.data$Epileptic.or.Control == 'Control'),]
# check if data are paired
if(!identical(paired.data.x$Household, paired.data.y$Household)) stop('paired data household not equal')

pair.t.test <- function(ASV, group = 'Epileptic.or.Control', data.x = paired.data.x, data.y = paired.data.y) {
    x <- paired.data.x[,ASV]
    y <- paired.data.y[,ASV]
    lfc <- mean(log2(x+1))-mean(log2(y+1)) # calculate log2 fold change
    result <- t.test(x,y, paired = TRUE, alternative = 'two.sided')
    p.value <- result$p.value
    return(c(lfc, p.value))
}
paired.tt <- t(sapply(taxa_names(ps.rare), pair.t.test)) %>% 
    data.frame() %>% 
    rownames_to_column('taxon')
colnames(paired.tt)[2:3] <- c('log2fold', 'paired.tt')

tax[paired.tt$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    cbind(log2fold = paired.tt$log2fold, p = paired.tt$paired.tt) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE)) -> paired.tt.res

paired.tt.res %>% filter(p <= alpha) %>% gt()
```

# Differential Abundance Test With GLM

We have found that the `Household` could be a strong factor that affect dogs' microbiome. To remove the effect of `Household` we propose this model:

$$ASV_i \sim Epileptic.or.Control + Household$$

## ALDEx2 GLM

```{r}
# Construct model matrix
model <- model.matrix(~ Epileptic.or.Control + Household, data.frame(sample_data(ps)))

# Perform CLR transformation and Monte Carlo sampling
x <- aldex.clr(t(otu_table(ps)), model, mc.samples=128, denom="all", verbose = FALSE)
aldex.glm <- aldex.glm(x, model) %>% 
    cbind(aldex.glm.effect(x, CI = TRUE, verbose = FALSE)) %>% 
    rownames_to_column('taxon')
```

```{r}
tax[aldex.glm$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    cbind(log2fold = aldex.glm$Epileptic.or.ControlEpileptic.diff.btw,
          p = aldex.glm$`Epileptic.or.ControlEpileptic:pval`) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE)) -> aldex.glm.res
aldex.glm.res %>% filter(p <= alpha) %>% gt()
```

## ANCOMBC

```{r, message=FALSE}
ancombc.da <- ancombc(data = ps,
                      formula = 'Epileptic.or.Control + Household',
                      n_cl = max.cores)
```

```{r}
tax_table(ps)[ancombc.da$res$p_val$taxon,] %>% 
    data.frame() %>% 
    rownames_to_column('taxon') %>% 
    left_join(ancombc.da$res$lfc, by = 'taxon') %>% 
    mutate(log2fold = log2(exp(Epileptic.or.ControlEpileptic))) %>% # convert natural log to log2
    dplyr::select(taxon,Phylum, Genus, log2fold) %>% 
    left_join(ancombc.da$res$p_val, by = 'taxon') %>% 
    mutate(p = Epileptic.or.ControlEpileptic) %>% 
    dplyr::select(taxon,Phylum, Genus, log2fold,p) %>% 
    arrange(str_rank(taxon, numeric = TRUE)) -> ancombc.res
ancombc.res %>% filter(p <= alpha) %>% gt()
```

## corncob

```{r}
corncob.da <- differentialTest(formula= ~ Epileptic.or.Control + Household,
                               phi.formula = ~ 1,
                               formula_null = ~ Household,
                               phi.formula_null = ~ 1,
                               test = 'LRT',
                               data = ps,
                               taxa_are_rows = FALSE)
```

```{r}
# convert corcob result to log2fold difference
corncob.extract.result <- function(corncob.da, i) {
    regression.result <- corncob.da$all_models[[i]]$coefficients
    ps <- corncob.da$data
    read.depth <- rowSums(otu_table(ps))
    treatment.name <- ps %>% sample_data() %>% data.frame() %>% filter(Epileptic.or.Control == 'Epileptic') %>% rownames()
    control.name <- ps %>% sample_data() %>% data.frame() %>% filter(Epileptic.or.Control == 'Control') %>% rownames()
    read.depth.treatment <- read.depth[treatment.name]
    read.depth.control <- read.depth[control.name]
    # p value
    p <- corncob.da$all_models[[i]]$coefficients['mu.Epileptic.or.ControlEpileptic','Pr(>|t|)']
    # relative abundance
    control.ra <- regression.result['mu.(Intercept)','Estimate'] %>% invlogit()
    treatment.ra <- regression.result[c('mu.(Intercept)','mu.Epileptic.or.ControlEpileptic'),'Estimate'] %>% sum() %>% invlogit()
    ra.diff <- treatment.ra - control.ra
    log2fold <- log2((mean(read.depth.treatment)*treatment.ra) / (mean(read.depth.control)*control.ra))
    summary <- c(log2fold,ra.diff,p)
    return(summary)
}
corncob.sum.tb <- sapply(1:length(taxa_names(ps)), function(i) corncob.extract.result(corncob.da, i)) %>% t() %>% data.frame()
rownames(corncob.sum.tb) <- taxa_names(ps)
colnames(corncob.sum.tb) <- c('log2fold','ra.diff','p')
```


```{r}
corncob.taxa <- names(corncob.da$p[which(corncob.da$p < alpha)])
# p value in the table is term specific, but significance is determined by wald test
corncob.res <- data.frame(tax[,c(2,6)], corncob.sum.tb) %>%
    rownames_to_column('taxon') %>% 
    #cbind(wald.p = corncob.da$p)
    mutate(p = corncob.da$p) %>% 
    arrange(str_rank(taxon, numeric = TRUE))
corncob.res %>% filter(taxon %in% corncob.taxa) %>% gt()
```

## LinDA

```{r}
linda.da <- linda(t(data.frame(otu_table(ps))),
                   data.frame(sample_data(ps)),
                   formula = '~ Epileptic.or.Control + Household',
                   feature.dat.type = 'count',
                   n.cores = max.cores,
                   verbose = FALSE)
```

```{r}
linda.res <- linda.da$output$Epileptic.or.ControlEpileptic %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE))
tax[linda.res$taxon,] %>% 
    data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    cbind(log2fold = linda.res$log2FoldChange, p = linda.res$pvalue) %>% 
    rownames_to_column('taxon') %>% 
    arrange(str_rank(taxon, numeric = TRUE)) -> linda.res
linda.res %>% filter(p <= alpha) %>% gt()
```

# Summary

```{r}
combined.result <- bind_rows(list(aldex.tt = aldex.tt.res,
                                  paired.tt = paired.tt.res,
                                  aldex.glm = aldex.glm.res,
                                  ancombc = ancombc.res,
                                  corncob = dplyr::select(corncob.res, -ra.diff),
                                  linDA = linda.res),
                             .id = 'method')
combined.result$taxon <- factor(combined.result$taxon, levels = unique(str_sort(combined.result$taxon, numeric = TRUE)))

p.value.tb <- combined.result %>% 
    # Here convert corncob p value to corncob wald test p value
    #mutate(p = if_else(method == 'corncob', wald.p, p)) %>% 
    dplyr::select(taxon, method, p) %>% 
    pivot_wider(names_from = method, values_from = p) %>% 
    column_to_rownames('taxon')
sig <- (p.value.tb <= alpha)
sig[is.na(sig)] <- FALSE

keep <- which(rowSums(sig) >= 3)
sig[keep,] %>% 
    data.frame() %>%
    rownames_to_column('taxon') %>% 
    gt() %>%
    data_color(columns = colnames(sig),
               fn = scales::col_factor(palette = scales::hue_pal()(2),
                                       domain = c(FALSE, TRUE)))
```

```{r}
# only keep ASV jointly agreed across different methods.
combined.result.sub <- combined.result %>% 
    filter(taxon %in% rownames(sig)[keep])# %>% 
    # mutate(new.p = if_else(method == 'corncob', wald.p, p)) %>% 
    # mutate(significant = if_else(new.p <= alpha&!is.na(new.p), TRUE, FALSE))
    #filter(p <= alpha, !(method == 'corncob'&is.na(wald.p)))
ggplot(combined.result.sub) +
    geom_bar(aes(x = taxon, y = log2fold, fill = method), position="dodge", stat = 'identity', width = 0.7) +
    #scale_color_manual(values = c('black','white')) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ylab('log 2 fold change')
```

correlation of p-value for each method (except for corncob).

```{r}
cor.tb <- combined.result %>% 
    dplyr::select(taxon, method, p) %>% 
    pivot_wider(names_from = method, values_from = p) %>% 
    column_to_rownames('taxon') %>% 
    na.omit() %>% 
    cor()
cor.tb
corrplot::corrplot(cor.tb,
                   method = 'color',
                   type = "upper",
                   col = colorRampPalette(c("blue", "white", "red"))(100),
                   tl.col = "black",
                   addCoef.col = "black")
```



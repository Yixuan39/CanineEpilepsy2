---
title: "Differential Abundance Analysis"
author: "Yixuan Yang"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    self_contained: true
---

# Set Up

```{r, message=FALSE}
rm(list = ls())
set.seed(2024)
library(tidyverse)
library(phyloseq)
library(here)
library(gt)
library(GGally)
library(ggcorrplot)
theme_set(theme_bw())

# DA tools
library(ALDEx2)
library(ANCOMBC)
library(corncob)
library(MicrobiomeStat) # for Linda

ps <- readRDS(here('data','following_study','ps.rds'))
ps.rare <- readRDS(here('data','following_study','ps_rarefied.rds'))
ps.present <- ps %>% transform_sample_counts(sign)

alpha <- 0.05
max.cores <- parallel::detectCores()
```

# Taxa Filtering

Before the DA analysis, we want to check the frequency of ASV present in each household. For ASV with low frequency across households, we can ignore them so that we can reduce the number of tests and save computational resources.

```{r} 
# check ASV present by household
present <- ps %>%
    transform_sample_counts(sign) %>% 
    psmelt() %>%
    group_by(Household, OTU) %>%
    summarise(present.in.house = sign(sum(Abundance)), .groups = 'drop') %>% 
    group_by(OTU) %>%
    summarise(house.freq = sum(present.in.house), .groups = 'drop') %>% 
    arrange(str_rank(OTU, numeric = TRUE))
head(present)
```

Tracing the number of ASV retained and average read depth after filtering

```{r} 
# test for filtering threshold
test.filter <- function(ps, present, threshold) {
    ASV <- present %>% filter(house.freq >= threshold) %>% pull(OTU)
    sub.ps.otu <- ps %>% prune_taxa(ASV, .) %>% otu_table()
    retained.read <- sub.ps.otu %>% rowSums() %>% mean()
    retained.taxa <- sub.ps.otu %>% ncol()
    orig.read <- otu_table(ps) %>% rowSums() %>% mean()
    orig.taxa <- otu_table(ps) %>% ncol()
    return(data.frame(taxon_size = retained.taxa/orig.taxa, average.read.depth = retained.read/orig.read))
}
trace <- map_dfr(1:49, function(i) test.filter(ps=ps, present=present, threshold=i))

ggplot(trace, aes(x = average.read.depth, y = taxon_size)) +
    geom_point() +
    geom_line() + 
    scale_x_reverse(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    xlab('percentage of reads remained') +
    ylab('percentage of ASV remained') 
```

We are showing percentage of read and ASV remained if we keep ASVs present in at least n households. In this study, we choose to keep ASVs that present in at least 5 households to retain 97% of reads and only test for 20% of ASVs.

```{r} 
head(trace)
# only keep ASVs present in more than 5 households
keep <- filter(present, house.freq >= 5) %>% pull(OTU)
```

Basic information of non-rarefied data

```{r} 
ps <- ps %>% prune_taxa(keep, .)
ps
```

Basic information of rarefied data

```{r} 
ps.rare <- ps.rare %>% prune_taxa(keep, .)
ps.rare
```

# Differential Abundance Analysis

## ALDEx2

### pairwise T-test

```{r message=FALSE}
clr.data <- aldex.clr(t(otu_table(ps)), as.character(sample_data(ps)$Epileptic.or.Control), mc.samples=128, denom="all")

aldex.t.test.p <- aldex.ttest(clr.data, paired.test = TRUE)
aldex.t.test.effect <- aldex.effect(clr.data, paired.test = TRUE, useMC = TRUE, verbose = FALSE)

if (!identical(rownames(aldex.t.test.p), rownames(aldex.t.test.effect))) stop('taxa names are not matched')
aldex.t.test <- data.frame(aldex.t.test.p, aldex.t.test.effect) %>% 
  rownames_to_column('taxon') %>%
  mutate(LFC = rab.win.Epileptic - rab.win.Control) %>% 
  mutate(p.value = we.ep) %>%
  dplyr::select(taxon, LFC, p.value)
    
aldex.t.test %>% arrange(str_rank(taxon, numeric = TRUE)) %>% head()
```

### GLM test

```{r message=FALSE}
model <- model.matrix(~ Epileptic.or.Control + Household, data.frame(sample_data(ps)))
clr.data <- aldex.clr(t(otu_table(ps)), model, mc.samples=128, denom="all")

aldex.glm.test.p <- aldex.glm(clr.data, model)
aldex.glm.test.effect <- aldex.glm.effect(clr.data, verbose = FALSE, useMC = TRUE)$Epileptic.or.ControlEpileptic
if (!identical(rownames(aldex.glm.test.p), rownames(aldex.glm.test.effect))) stop('taxa names are not matched')

aldex.glm.test <- data.frame(p.value = aldex.glm.test.p$`Epileptic.or.ControlEpileptic:pval`, aldex.glm.test.effect) %>% 
    rownames_to_column('taxon') %>%
    mutate(LFC = rab.win.1 - rab.win.0) %>% # 0 is control, 1 is epileptic, set is `data-cleaning.Rmd`
    dplyr::select(taxon, LFC, p.value)

aldex.glm.test %>% arrange(str_rank(taxon, numeric = TRUE)) %>% head()
```

## ANCOMBC

```{r message=FALSE}
ancombc.test <- ancombc(data = ps,
                        formula = 'Epileptic.or.Control + Household',
                        taxa_are_rows = FALSE,
                        prv_cut = 0,
                        n_cl = max.cores)

ancombc.test <- data.frame(taxon = ancombc.test$res$lfc$taxon,
                           # convert logfold change to log2fold change
                           LFC = log2(exp(ancombc.test$res$lfc$Epileptic.or.ControlEpileptic)),
                           p.value = ancombc.test$res$p_val$Epileptic.or.ControlEpileptic)

ancombc.test %>% arrange(str_rank(taxon, numeric = TRUE)) %>% head
```

## corncob

```{r message=FALSE}
corncob.test <- differentialTest(formula= ~ Epileptic.or.Control + Household,
                                 phi.formula = ~ 1,
                                 formula_null = ~ Household,
                                 phi.formula_null = ~ 1,
                                 test = 'LRT',
                                 # filter_discriminant = FALSE, 
                                 # fdr_cutoff = 1,
                                 data = ps,
                                 taxa_are_rows = FALSE)

# convert corcob result to log2fold difference
corncob.extract.result <- function(corncob.da, i) {
    regression.result <- corncob.da$all_models[[i]]$coefficients
    ps <- corncob.da$data
    read.depth.epileptic <- ps %>% subset_samples(Epileptic.or.Control == 'Epileptic') %>% otu_table() %>% rowSums()
    read.depth.control <- ps %>% subset_samples(Epileptic.or.Control == 'Control') %>% otu_table() %>% rowSums()
    # p value
    p <- corncob.da$p[i]
    # relative abundance
    RA.ctl <- regression.result['mu.(Intercept)','Estimate'] %>% invlogit()
    RA.epi <- regression.result[c('mu.(Intercept)','mu.Epileptic.or.ControlEpileptic'),'Estimate'] %>% sum() %>% invlogit()
    LFC <- log2((mean(read.depth.epileptic)*RA.epi) / (mean(read.depth.control)*RA.ctl))
    summary <- data.frame(LFC = LFC, p.value = p) %>% rownames_to_column('taxon')
    return(summary)
}
corncob.test <- map_dfr(1:length(taxa_names(ps)), function(i) corncob.extract.result(corncob.test, i)) 
corncob.test %>% arrange(str_rank(taxon, numeric = TRUE)) %>% head
```

## LinDA

```{r}
linda.test <- linda(t(data.frame(otu_table(ps))),
                   data.frame(sample_data(ps)),
                   formula = '~ Epileptic.or.Control + Household',
                   feature.dat.type = 'count',
                   n.cores = max.cores,
                   verbose = FALSE)

linda.test <- linda.test$output$Epileptic.or.ControlEpileptic %>% 
    dplyr::select(log2FoldChange, pvalue) %>%
    rownames_to_column('taxon') 
colnames(linda.test)[2:3] <- c('LFC', 'p.value')

linda.test %>% arrange(str_rank(taxon, numeric = TRUE)) %>% head()
```

## pairwise T-test on rarefied data

```{r}
paired.t.test <- function(data) {
    splited.data <- data %>% 
        arrange(Household, Epileptic.or.Control) %>% 
        split(.$Epileptic.or.Control)
    t.test.result <- t.test(splited.data[['Epileptic']]$Abundance,
                            splited.data[['Control']]$Abundance,
                            paired = TRUE, alternative = 'two.sided')
    data.frame(taxon = unique(data$OTU),
               LFC = log2(mean(splited.data[['Epileptic']]$Abundance + 1)) - log2(mean(splited.data[['Control']]$Abundance + 1)),
               p.value = t.test.result$p.value)
}

pairwise.t.test <- psmelt(ps.rare) %>%
    group_by(OTU) %>%
    group_split() %>%
    map_dfr(paired.t.test)

pairwise.t.test %>% arrange(str_rank(taxon, numeric = TRUE)) %>% head()
```


# Comparative Analysis

Here we compare the results of different methods. We first show the top 10 ASVs with the smallest p-value for each method.

```{r}
test.results <- list("ALDEx2 t test" = aldex.t.test,
                     "ALDEx2 GLM" = aldex.glm.test,
                     "ANCOM-BC" = ancombc.test,
                     "corncob" = corncob.test,
                     "LinDA" = linda.test, 
                     "paired t test" = pairwise.t.test) %>% 
    bind_rows(.id = 'method') %>% 
    group_by(method) %>% arrange(str_rank(taxon, numeric = TRUE)) %>% ungroup()

tax <- tax_table(ps) %>% 
    as.data.frame() %>% 
    dplyr::select(Phylum, Genus) %>% 
    rownames_to_column('taxon')

p.value.tb <- test.results %>% 
    dplyr::select(taxon, method, p.value) %>% 
    pivot_wider(names_from = method, values_from = p.value) %>%
    rowwise() %>%
    mutate(SignificantCount = sum(c_across(-taxon) < alpha))

top.p <- p.value.tb %>%
    left_join(tax,., by = 'taxon') %>% 
    arrange(desc(SignificantCount)) %>%
    dplyr::select(-SignificantCount)

tb <- top.p %>% 
    head(10) %>% 
    gt() %>% 
    fmt_number(decimals = 4) %>% 
    data_color(columns = colnames(top.p)[4:9],
               colors = scales::col_bin(palette = c(scales::hue_pal()(1), "transparent"),
                                        bins = c(-Inf, 0.05, Inf)))
tb
writexl::write_xlsx(top.p, here('data', 'following_study', 'top10_pvalue.xlsx'))
```

Effect size of top 10 ASVs for each method.

```{r}
test.results$taxon <- factor(test.results$taxon,
                             levels = top.p$taxon)
effect.plot <- test.results %>% 
    filter(method != 'corncob') %>% 
    filter(taxon %in% head(top.p$taxon, 10)) %>% 
    ggplot() +
        geom_bar(aes(x = taxon, y = LFC, fill = method),
                 position="dodge", stat = 'identity', width = 0.7) +
        theme(axis.text.x = element_text(angle = 60, hjust = 1)) 
effect.plot
```

correlation of p-value for each method.

```{r}
top.p %>%  
    dplyr::select(-c(Phylum, Genus)) %>%
    column_to_rownames('taxon') %>% 
    ggpairs(progress = FALSE)

cor.plot <- top.p %>%  
    dplyr::select(-c(Phylum, Genus)) %>%
    column_to_rownames('taxon') %>%
    cor() %>%
    ggcorrplot(lab = TRUE, type = 'lower', show.legend = FALSE, tl.cex = 10)
cor.plot
```

```{r include=FALSE}
library(patchwork)
cor.plot + effect.plot + plot_annotation(tag_levels = 'a')
```

```{r}
sessioninfo::session_info()
```


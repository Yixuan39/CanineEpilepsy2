---
title: "Explore Collinsella"
output: html_document
date: "2024-07-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set Up

```{r message=FALSE}
library(tidyverse)
library(here)
library(phyloseq)
theme_set(theme_bw())

ps <- readRDS(here('data','following_study','ps.rds'))

sam <- sample_data(ps) %>% data.frame()
otu <- otu_table(ps) %>% data.frame()
tax <- tax_table(ps) %>% data.frame() %>% rownames_to_column('taxon')
tax.collin <- tax %>% filter(Genus == 'Collinsella')
otu.collin <- otu[,tax.collin$taxon] %>% 
    mutate(Collinsella = rowSums(.))
otu.log <- (otu.collin + 1) %>% 
    # vegan::decostand('clr', pseudocount = 0.5) %>% # prior value same as aldex2
    log2()
# Here only keep collinsella that have prevlance > 0.1
tax.collin.keep <- names(colSums(otu.collin)[colSums(sign(otu.collin))>=10]) %>% 
    str_sort(numeric = TRUE)

sam.long <- sam %>%
    bind_cols(otu.collin) %>% 
    pivot_longer(cols = tax.collin.keep, names_to = 'ASV', values_to = 'abundance') %>% 
    mutate(exist = sign(abundance)) %>% 
    mutate(log_abn = log2(abundance + 1))
```

In the session of differential abundance analysis, we have found that `Collinsella` could be an influential ASV. Here we investigate its existence.

```{r}
otu.epi <- otu.log %>%
    bind_cols(Condition = sam$Epileptic.or.Control) %>% 
    filter(Condition == 'Epileptic') %>% 
    dplyr::select(-Condition)
otu.ctl <- otu.log %>% 
    bind_cols(Condition = sam$Epileptic.or.Control) %>% 
    filter(Condition == 'Control') %>% 
    dplyr::select(-Condition)

otu.diff <- data.frame(otu.epi - otu.ctl) %>%
    mutate(Household = unique(sam$Household)) %>% 
    pivot_longer(tax.collin.keep, names_to = 'ASV', values_to = "LFC")

# ggplot(otu.diff) +
#     geom_bar(aes(x = as.numeric(Household), y = LFC, fill = ASV), stat = 'identity') +
#     labs(x = 'Household', y = 'log 2 fold change')

ggplot(otu.diff) +
    geom_bar(aes(x = as.numeric(Household), y = LFC, fill = (LFC > 0)), stat = 'identity') +
    facet_wrap(~ASV, scales = 'free_y') +
    labs(x = 'Household', y = 'log 2 fold change', fill = 'LFC > 0')

ggplot(sam.long) +
    geom_violin(aes(x = Epileptic.or.Control, y = log_abn)) +
    geom_jitter(aes(x = Epileptic.or.Control, y = log_abn, colour = (abundance == 0)), width = 0.3) +
    labs(y = 'log 2 abundance', color='Structual Zero') +
    facet_wrap(~ASV, scales = 'free_y')
```

Are there always more Collinsella ASVs in Epileptic group than control group?

```{r}
library(rstatix)
sapply(tax.collin.keep, function(taxa) pairwise_sign_test(filter(sam.long, ASV == taxa),
                                                          log_abn ~ Epileptic.or.Control, 
                                                          ref.group = 'Epileptic', 
                                                          alternative = 'greater')) %>% t()
```


## Distribution of Collinsella

```{r message=FALSE}
collin.prop <- ps %>%
    transform_sample_counts(function(x) x/sum(x)) %>% 
    subset_taxa(Genus == 'Collinsella') %>% 
    otu_table() %>% 
    data.frame() %>% 
    pivot_longer(starts_with('ASV'), names_to = 'ASV', values_to = 'proportion')

collin.prop$ASV <- factor(collin.prop$ASV, levels = str_sort(unique(collin.prop$ASV), numeric = TRUE))
ggplot(collin.prop) +
    geom_boxplot(aes(x = ASV, y = proportion)) +
    # geom_jitter(aes(x = ASV, y = proportion)) +
    labs(title = 'Mean Proportion of Collinsella') +
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

```{r}
collin.prop %>% 
    group_by(ASV) %>%
    summarise(mean = mean(proportion), sd = sd(proportion))
```


# Contingency Tables

Existence frequency of Collinsella across Epi v.s. Control groups

```{r}
tb <- xtabs(exist ~ Epileptic.or.Control + ASV, data = sam.long) 
ftable(tb)
```

Epiliptic cross sex table for each Collinsella ASVs

```{r}
ftable(xtabs(exist ~ Sex  + Epileptic.or.Control + ASV, data = sam.long))
```

Does Epileptic or Control group associate with sex for Collinsella ASV?

```{r}
tb <- xtabs(exist ~ Sex  + Epileptic.or.Control, data = sam.long %>% filter(ASV != 'Collinsella')) 
ftable(tb)
chisq.test(tb)
```

Does Drug usage associate on sex to the existence frequency of Collinsella?

```{r}
tb <- xtabs(exist ~ Pheno.Y.N + Sex, data = sam.long %>% filter(ASV != 'Collinsella' & Epileptic.or.Control == 'Epileptic')) 
ftable(tb)
chisq.test(tb)
```

```{r}
sam.long <- sam.long %>% 
    mutate(Age = Age..months./12) %>% 
    mutate(pesudo_abn = abundance + 1)
#lapply(tax.collin.keep, function(taxa) {lm(pesudo_abn ~ Age, data = sam.long %>% filter(ASV == taxa)) %>% summary()})
result <- list()
for (taxa in tax.collin.keep) {
    result[[taxa]] <- MASS::glm.nb(pesudo_abn ~ Age, data = sam.long %>% filter(ASV == taxa)) %>% summary()
    #result[[taxa]] <- lm(log_abn ~ Age, data = sam.long %>% filter(ASV == taxa)) %>% summary()
}
result
```

